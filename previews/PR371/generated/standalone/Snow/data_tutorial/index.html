<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Scraping SNOTEL Data · ClimaLSM.jl</title><meta name="title" content="Scraping SNOTEL Data · ClimaLSM.jl"/><meta property="og:title" content="Scraping SNOTEL Data · ClimaLSM.jl"/><meta property="twitter:title" content="Scraping SNOTEL Data · ClimaLSM.jl"/><meta name="description" content="Documentation for ClimaLSM.jl."/><meta property="og:description" content="Documentation for ClimaLSM.jl."/><meta property="twitter:description" content="Documentation for ClimaLSM.jl."/><script data-outdated-warner src="../../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../../assets/documenter.js"></script><script src="../../../../search_index.js"></script><script src="../../../../siteinfo.js"></script><script src="../../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../../../">ClimaLSM.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox"/><label class="tocitem" for="menuitem-2"><span class="docs-label">APIs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-2-1" type="checkbox"/><label class="tocitem" for="menuitem-2-1"><span class="docs-label">ClimaLSM</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/ClimaLSM/">ClimaLSM</a></li><li><a class="tocitem" href="../../../../APIs/Regridder/">Parameter Dataset Tools</a></li><li><a class="tocitem" href="../../../../APIs/shared_utilities/">Shared Utilities</a></li><li><input class="collapse-toggle" id="menuitem-2-1-4" type="checkbox"/><label class="tocitem" for="menuitem-2-1-4"><span class="docs-label">Soil</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Soil/">Soil Energy and Hydrology</a></li><li><a class="tocitem" href="../../../../APIs/SoilBiogeochemistry/">Soil Biogeochemistry</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-1-5" type="checkbox"/><label class="tocitem" for="menuitem-2-1-5"><span class="docs-label">Canopy</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/canopy/Canopy/">Canopy Models</a></li><li><a class="tocitem" href="../../../../APIs/canopy/PlantHydraulics/">Plant Hydraulics</a></li><li><a class="tocitem" href="../../../../APIs/canopy/Photosynthesis/">Canopy Photosynthesis</a></li><li><a class="tocitem" href="../../../../APIs/canopy/RadiativeTransfer/">Canopy RT</a></li><li><a class="tocitem" href="../../../../APIs/canopy/CanopyEnergy/">Canopy Energy</a></li><li><a class="tocitem" href="../../../../APIs/canopy/StomatalConductance/">Canopy Stomatal Conductance</a></li><li><a class="tocitem" href="../../../../APIs/canopy/AutotrophicRespiration/">Canopy Autotrophic Respiration</a></li></ul></li><li><a class="tocitem" href="../../../../APIs/SurfaceWater/">Surface Water Models</a></li><li><a class="tocitem" href="../../../../APIs/Bucket/">Bucket Model</a></li><li><a class="tocitem" href="../../../../APIs/Snow/">Snow Model</a></li></ul></li></ul></li><li><a class="tocitem" href="../../../../Contributing/">Contribution guide</a></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">For model developers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Usage/model_tutorial/">Intro to standalone models</a></li><li><a class="tocitem" href="../../Usage/LSM_single_column_tutorial/">Intro to multi-component models</a></li><li><a class="tocitem" href="../../Usage/domain_tutorial/">Intro to ClimaLSM Domains</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox" checked/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Running simulations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-2-1" type="checkbox"/><label class="tocitem" for="menuitem-4-2-1"><span class="docs-label">Bucket LSM</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Bucket/bucket_tutorial/">Introduction to the Land Bucket Model</a></li><li><a class="tocitem" href="../../Bucket/coupled_bucket/">Setting up a Coupled Simulation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2-2"><span class="docs-label">Soil modeling</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Soil/richards_equation/">Richards Equation</a></li><li><a class="tocitem" href="../../Soil/soil_energy_hydrology/">Energy and Hydrology</a></li><li><a class="tocitem" href="../../Soil/freezing_front/">Phase Changes</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2-3" type="checkbox"/><label class="tocitem" for="menuitem-4-2-3"><span class="docs-label">Canopy modeling</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Canopy/canopy_tutorial/">Standalone Canopy</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2-4" type="checkbox"/><label class="tocitem" for="menuitem-4-2-4"><span class="docs-label">Integrated soil+canopy modeling</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../integrated/soil_canopy_tutorial/">Coupled Canopy and Soil</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2-5" type="checkbox"/><label class="tocitem" for="menuitem-4-2-5"><span class="docs-label">Bucket LSM</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Bucket/bucket_tutorial/">Introduction to the Land Bucket Model</a></li><li><a class="tocitem" href="../../Bucket/coupled_bucket/">Setting up a Coupled Simulation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2-6" type="checkbox" checked/><label class="tocitem" for="menuitem-4-2-6"><span class="docs-label">Snow Modeling</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../base_tutorial/">Seasonal Snow Timeseries Generation with a Neural Network</a></li><li class="is-active"><a class="tocitem" href>Scraping SNOTEL Data</a></li></ul></li></ul></li></ul></li><li><a class="tocitem" href="../../../../folderstructure/">Repository structure</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li><a class="is-disabled">Running simulations</a></li><li><a class="is-disabled">Snow Modeling</a></li><li class="is-active"><a href>Scraping SNOTEL Data</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Scraping SNOTEL Data</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaLSM.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaLSM.jl/../../../../.." title="View source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Scraping-SNOTEL-Data"><a class="docs-heading-anchor" href="#Scraping-SNOTEL-Data">Scraping SNOTEL Data</a><a id="Scraping-SNOTEL-Data-1"></a><a class="docs-heading-anchor-permalink" href="#Scraping-SNOTEL-Data" title="Permalink"></a></h1><p>This tutorial shows you how to make use of the code developed for scraping SNOTEL site data in order to generate datasets for use in training artificial intelligence models for seasonal snow forecasting. The code below contains a commented version of the code used to produce <code>cleandata.csv</code>, which is used in the base tutorial for snow forecasting, as well as the paper. However, exploration of the optional arguments or requesting of alternative <a href="https://www.nrcs.usda.gov/wps/portal/wcc/home/dataAccessHelp/webService/webServiceReference#elementCodes">SNOTEL data codes</a> offers additional utility in creating alternative data sets for further investigation.</p><p>We begin by importing the data tools module, as well as other required packages:</p><pre><code class="language-julia hljs">using ClimaLSM.Snow.DataTools
using ClimaLSM
using DataFrames, Dates, CSV #CSV is for saving, can leave out otherwise</code></pre><p>We then define constants that will be used in the cleaning of the SNOTEL data, such as conversion constants from imperial to metric units, and the sensor limits defined in the <a href="https://directives.sc.egov.usda.gov/OpenNonWebContent.aspx?content=27630.wba">SNOTEL Engineering Handbook</a>. Some SNOTEL sensors measure in imperial units, and some measure in metric units, and the data portal will round converted values if a sensor stream is requested in units other than its original measurement. Therefore, we will scrape data in the originally measured units to limit systemic errors.</p><pre><code class="language-julia hljs">const inch2meter = 0.0254
const kmphr2mps = 5.0 / 18.0

filter_val = Dict{Symbol, Tuple{Real, Real}}(
    :SWE =&gt; (0.0, 250.0),
    :z =&gt; (0.0, 420.0),
    :precip =&gt; (0.0, 250.0),
    :rel_hum_avg =&gt; (10.0, 100.0),
    :sol_rad_avg =&gt; (0.0, 1500.0),
    :wind_speed_avg =&gt; (0.0, 216.0),
    :air_temp_avg =&gt; (-55.0, 60.0),
)

scales = Dict{Symbol, Real}(
    :SWE =&gt; inch2meter,
    :z =&gt; inch2meter,
    :precip =&gt; inch2meter,
    :rel_hum_avg =&gt; 0.01,
    :wind_speed_avg =&gt; kmphr2mps,
);</code></pre><p>We next proceed to outline which stations will be scraped by defining a dictionary of station IDs, paired with the date range to be scraped. &quot;<code>start</code>&quot; refers to 1850-01-01 or the first available date, while &quot;<code>end</code>&quot; refers to 2023-01-01 or the last available date. Most of these stations are commented out for the sake of speed and readability in generating the tutorial, but can be uncommented to yield the full dataset found in <code>cleandata.csv</code> used in the <a href="../base_tutorial/">base tutorial</a>. Stations were selected based upon their availability of the features utilized in creating the model used in the paper.</p><pre><code class="language-julia hljs">good_stations = Dict{Int, Tuple{String, String}}(
    1030 =&gt; (&quot;start&quot;, &quot;2016-01-01&quot;),
    1053 =&gt; (&quot;2010-01-01&quot;, &quot;end&quot;),
    #=1083 =&gt; (&quot;2013-01-01&quot;, &quot;end&quot;),
    1105 =&gt; (&quot;start&quot;, &quot;2012-06-01&quot;),
    1122 =&gt; (&quot;start&quot;, &quot;end&quot;),
    1123 =&gt; (&quot;start&quot;, &quot;end&quot;),
    1159 =&gt; (&quot;start&quot;, &quot;end&quot;),
    1168 =&gt; (&quot;start&quot;, &quot;end&quot;),
    1170 =&gt; (&quot;start&quot;, &quot;end&quot;),
    1254 =&gt; (&quot;2018-01-01&quot;, &quot;end&quot;),
    1286 =&gt; (&quot;start&quot;, &quot;end&quot;),
    306 =&gt; (&quot;2013-01-01&quot;, &quot;2020-01-01&quot;),
    316 =&gt; (&quot;start&quot;, &quot;end&quot;),
    344 =&gt; (&quot;start&quot;, &quot;end&quot;),
    367 =&gt; (&quot;2022-09-01&quot;, &quot;2023-04-01&quot;),
    395 =&gt; (&quot;start&quot;, &quot;end&quot;),
    457 =&gt; (&quot;2008-01-01&quot;, &quot;end&quot;),
    482 =&gt; (&quot;start&quot;, &quot;2010-01-01&quot;),
    491 =&gt; (&quot;2013-01-01&quot;, &quot;end&quot;),
    532 =&gt; (&quot;2013-01-01&quot;, &quot;2022-01-01&quot;),
    551 =&gt; (&quot;start&quot;, &quot;end&quot;),
    571 =&gt; (&quot;start&quot;, &quot;end&quot;),
    599 =&gt; (&quot;start&quot;, &quot;end&quot;),
    608 =&gt; (&quot;start&quot;, &quot;2018-01-01&quot;),
    613 =&gt; (&quot;2007-01-01&quot;, &quot;2015-01-01&quot;),
    665 =&gt; (&quot;start&quot;, &quot;2022-01-01&quot;),
    734 =&gt; (&quot;start&quot;, &quot;end&quot;),
    737 =&gt; (&quot;start&quot;, &quot;end&quot;),
    744 =&gt; (&quot;2014-01-01&quot;, &quot;2016-01-01&quot;),
    832 =&gt; (&quot;start&quot;, &quot;end&quot;),
    845 =&gt; (&quot;2014-01-01&quot;, &quot;end&quot;),
    854 =&gt; (&quot;2019-01-01&quot;, &quot;end&quot;),
    857 =&gt; (&quot;start&quot;, &quot;end&quot;),
    921 =&gt; (&quot;2019-01-01&quot;, &quot;end&quot;),
    922 =&gt; (&quot;2015-01-01&quot;, &quot;2018-01-01&quot;),
    942 =&gt; (&quot;2009-01-01&quot;, &quot;2018-01-01&quot;),
    969 =&gt; (&quot;2011-01-01&quot;, &quot;end&quot;),
    974 =&gt; (&quot;start&quot;, &quot;end&quot;),
    978 =&gt; (&quot;2005-01-01&quot;, &quot;2018-01-01&quot;),=#
);</code></pre><p>We also extract a <code>DataFrame</code> matching station ID to various station metadata, in order to automate some of the scraping process and pass some station metadata that is used for analysis in the paper. This resulting <code>DataFrame</code> can also be used to see other available SNOTEL station IDs for scraping, in order to create custom datasets.</p><pre><code class="language-julia hljs">metadata = snotel_metadata();
metacols = [&quot;id&quot;, &quot;state&quot;, &quot;elev&quot;, &quot;lat&quot;, &quot;lon&quot;]
DataFrames.rename!(metadata, Symbol.(metacols));</code></pre><p>We then loop through each site to scrape and follow an automated data pipeline, consisting of:</p><ul><li>Extracting the daily and hourly timeseries from the site</li><li>Applying the sensor bounds over each data timeseries (i.e. remove sensor error)</li><li>Converting the hourly dataset into a daily dataset</li><li>Filling holes/features in the daily series with the hourly series</li><li>Scaling all data to the appropriate metric units</li><li>Restricting data to complete cases</li><li>Making the differential variables ( <span>$\frac{dz}{dt}$</span>, etc.)</li><li>Removing negative precipitation cases (i.e. where the water year resets, or sensor error)</li><li>Attaching appropriate metadata</li></ul><pre><code class="language-julia hljs">allsites = Any[];
for site in sort(collect(keys(good_stations)))
    state = metadata[metadata[!, :id] .== site, :state][1]
    start_date = good_stations[site][1]
    end_date = good_stations[site][2]
    daily = apply_bounds(
        sitedata_daily(site, state, start = start_date, finish = end_date),
        filter_val,
    )
    hourly = apply_bounds(
        sitedata_hourly(site, state, start = start_date, finish = end_date),
        filter_val,
    )
    hourly_d = hourly2daily(hourly)
    gap_daily = rectify_daily_hourly(daily, hourly_d)
    daily_scaled = scale_cols(gap_daily, scales)
    daily_clean = daily_scaled[completecases(daily_scaled), :]
    daily_clean = makediffs(daily_clean, Day(1))
    good_vals = daily_clean[!, :dprecipdt] .&gt;= 0.0
    daily_clean = daily_clean[good_vals, Not(:precip)]
    #show(describe(daily_clean), allrows = true, allcols = true)
    #print(&quot;\nSIZE: &quot;, nrow(daily_clean), &quot;\n&quot;)

    daily_clean[!, :id] .= site
    daily_clean[!, :elev] .= metadata[metadata[!, :id] .== site, :elev][1]
    daily_clean[!, :lat] .= metadata[metadata[!, :id] .== site, :lat][1]
    daily_clean[!, :lon] .= metadata[metadata[!, :id] .== site, :lon][1]

    push!(allsites, daily_clean)
end;</code></pre><p>With the sites complete, we condense all sites into a single <code>DataFrame</code>,</p><pre><code class="language-julia hljs">totaldata = deepcopy(allsites[1])
for site in allsites[2:end]
    append!(totaldata, site)
end</code></pre><p>and a final <code>CSV.write(&quot;newcleanfiletestdata.csv&quot;, totaldata)</code> call will save the file.</p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../base_tutorial/">« Seasonal Snow Timeseries Generation with a Neural Network</a><a class="docs-footer-nextpage" href="../../../../folderstructure/">Repository structure »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Monday 18 December 2023 23:31">Monday 18 December 2023</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
