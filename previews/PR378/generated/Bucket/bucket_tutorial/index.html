<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Introduction to the Land Bucket Model · ClimaLSM.jl</title><meta name="title" content="Introduction to the Land Bucket Model · ClimaLSM.jl"/><meta property="og:title" content="Introduction to the Land Bucket Model · ClimaLSM.jl"/><meta property="twitter:title" content="Introduction to the Land Bucket Model · ClimaLSM.jl"/><meta name="description" content="Documentation for ClimaLSM.jl."/><meta property="og:description" content="Documentation for ClimaLSM.jl."/><meta property="twitter:description" content="Documentation for ClimaLSM.jl."/><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">ClimaLSM.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox"/><label class="tocitem" for="menuitem-2"><span class="docs-label">APIs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-2-1" type="checkbox"/><label class="tocitem" for="menuitem-2-1"><span class="docs-label">ClimaLSM</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/ClimaLSM/">ClimaLSM</a></li><li><a class="tocitem" href="../../../APIs/Regridder/">Parameter Dataset Tools</a></li><li><a class="tocitem" href="../../../APIs/shared_utilities/">Shared Utilities</a></li><li><input class="collapse-toggle" id="menuitem-2-1-4" type="checkbox"/><label class="tocitem" for="menuitem-2-1-4"><span class="docs-label">Soil</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Soil/">Soil Energy and Hydrology</a></li><li><a class="tocitem" href="../../../APIs/SoilBiogeochemistry/">Soil Biogeochemistry</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-1-5" type="checkbox"/><label class="tocitem" for="menuitem-2-1-5"><span class="docs-label">Canopy</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/canopy/Canopy/">Canopy Models</a></li><li><a class="tocitem" href="../../../APIs/canopy/PlantHydraulics/">Plant Hydraulics</a></li><li><a class="tocitem" href="../../../APIs/canopy/Photosynthesis/">Canopy Photosynthesis</a></li><li><a class="tocitem" href="../../../APIs/canopy/RadiativeTransfer/">Canopy RT</a></li><li><a class="tocitem" href="../../../APIs/canopy/CanopyEnergy/">Canopy Energy</a></li><li><a class="tocitem" href="../../../APIs/canopy/StomatalConductance/">Canopy Stomatal Conductance</a></li><li><a class="tocitem" href="../../../APIs/canopy/AutotrophicRespiration/">Canopy Autotrophic Respiration</a></li></ul></li><li><a class="tocitem" href="../../../APIs/SurfaceWater/">Surface Water Models</a></li><li><a class="tocitem" href="../../../APIs/Bucket/">Bucket Model</a></li><li><a class="tocitem" href="../../../APIs/Snow/">Snow Model</a></li></ul></li></ul></li><li><a class="tocitem" href="../../../Contributing/">Contribution guide</a></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">For model developers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Usage/LSM_single_column_tutorial/">Intro to multi-component models</a></li><li><a class="tocitem" href="../../Usage/domain_tutorial/">Intro to ClimaLSM Domains</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox" checked/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Running simulations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-2-1" type="checkbox"/><label class="tocitem" for="menuitem-4-2-1"><span class="docs-label">Soil modeling</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Soil/richards_equation/">Richards Equation</a></li><li><a class="tocitem" href="../../Soil/soil_energy_hydrology/">Energy and Hydrology</a></li><li><a class="tocitem" href="../../Soil/freezing_front/">Phase Changes</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2-2"><span class="docs-label">Canopy modeling</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Canopy/canopy_tutorial/">Standalone Canopy</a></li><li><a class="tocitem" href="../../Canopy/soil_canopy_tutorial/">Coupled Canopy and Soil</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2-3" type="checkbox" checked/><label class="tocitem" for="menuitem-4-2-3"><span class="docs-label">Bucket LSM</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Introduction to the Land Bucket Model</a><ul class="internal"><li class="toplevel"><a class="tocitem" href="#Simulating-a-standalone-bucket-model"><span>Simulating a standalone bucket model</span></a></li><li class="toplevel"><a class="tocitem" href="#References"><span>References</span></a></li></ul></li><li><a class="tocitem" href="../coupled_bucket/">Setting up a Coupled Simulation</a></li></ul></li></ul></li></ul></li><li><a class="tocitem" href="../../../folderstructure/">Repository structure</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li><a class="is-disabled">Running simulations</a></li><li><a class="is-disabled">Bucket LSM</a></li><li class="is-active"><a href>Introduction to the Land Bucket Model</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Introduction to the Land Bucket Model</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaLSM.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaLSM.jl/../../../.." title="View source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Introduction-to-the-Land-Bucket-Model"><a class="docs-heading-anchor" href="#Introduction-to-the-Land-Bucket-Model">Introduction to the Land Bucket Model</a><a id="Introduction-to-the-Land-Bucket-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Introduction-to-the-Land-Bucket-Model" title="Permalink"></a></h1><p>The land bucket model implemented in ClimaLSM is based off of the models of Manabe (1969)[1], Milly and Shmakin (2002)[2], and the SLIM model (Laguë, Bonan, Swann 2019)[3], with small changes, as noted.</p><p>This tutorial explains in brief the core equations and the necessary parameters of the bucket model, and shows how to set up a simulation in standalone mode. More detail for coupled runs can be found in the ClimaCoupler.jl <a href="https://clima.github.io/ClimaCoupler.jl/dev/">documentation</a> and in the coupled simulation <a href="https://clima.github.io/ClimaLSM.jl/dev/generated/coupled_bucket/">tutorial</a>.</p><p>At each coordinate point on the surface, we solve ordinary differential equations for the subsurface water storage of land (<code>W</code>, m), the snow water equivalent multiplied by the snow cover fraction (<code>σS</code>, m), and the surface water content of land (<code>Ws</code>, m). We additionally solve a partial differential equation for the land temperature as a function of depth (<code>T</code>, K). The snow cover fraction is given by a heaviside function in the current code.</p><p>In what follows, surface fluxes over <code>soil</code> generally indicate fluxes over non-snow-covered regions. The exception is the albedo of vegetated and non-vegetated surfaces, for which we use the symbol <code>α_sfc</code>.</p><p>We have:</p><p><span>$\frac{d W}{dt} = I,$</span></p><p><span>$\frac{d Ws}{dt} = P_{liq} + σM - (1-σ) E_{soil} - I,$</span></p><p><span>$\frac{d σS}{dt} = P_{snow} - σ(E_{snow} + M),$</span></p><p><span>$ρc \frac{\partial T}{\partial t} = κ_{soil} \frac{\partial T}{\partial z}$</span></p><p><span>$F_{bot} = 0.0 = -κ_{soil} \frac{\partial T}{\partial z}|_{z = z_{bot}}$</span></p><p><span>$(1-σ) (R_n+ SHF + LHF)_{soil} + σG_{undersnow} = -κ_{soil} \frac{\partial T}{\partial z}|_{z = z_{sfc}}$</span></p><p><span>$G_{undersnow} = (R_n+ SHF + LHF)_{snow} - F_{intosnow}$</span></p><p><span>$F_{intosnow} = -ρ_l L_{f,0} (M+E_{snow})$</span></p><p><span>$R_n = -(1-α)*SW↓ -LW↓ + σ_{SB} T_{sfc}^4$</span></p><p>where the water fluxes are : <code>I</code> the infiltration as defined in [1], <code>P_liq</code> (m/s) the water volume flux of precipitation, <code>P_snow</code> (m/s) the water volume flux in the form of snow, <code>(1-σ)E_soil</code> (m/s) the water volume flux in evaporation, <code>σE_snow</code> the water volume flux in sublimation from snow, and <code>σM</code> (m/s) the water volume flux in melting of snow. The melt rate is defined via the net surface flux when surface temperatures are above freezing.</p><p>For heat fluxes, we have <code>R_n</code> the net radiation, <code>SHF</code> the sensible heat flux, <code>LHF</code> the latent heat flux, <code>G_undersnow</code> the heat flux into snow-covered soil, and <code>F_intosnow</code> the heat flux into the snowpack itself. Note that the water balance equation for snow is equivalent to the heat balance equation, since we neglect the sensible heat contribution and only track the latent heat contribution.</p><p>Finally, we have <code>α_sfc(lat, lon)</code> the (snow-free) surface albedo, <code>ρc</code> the volumetric heat capacity of the land, <code>σ_SB</code> the Stefan-Boltzmann constant,  and <code>κ_soil</code> the thermal conductivity. The albedo is a linear interpolation between the albedo of surface and snow, as decribed in [3]. The surface temperature is taken to be equal to the temperature T at the first grid point, assumed to be the same for soil and snow. At present the snow cover fraction is a heaviside function, and only one set of surface fluxes is computed per grid point.</p><p>Turbulent surface fluxes of sensible heat, latent heat, and water vapor (<code>SHF, LHF, E</code>) are computed using Monin-Obukhov theory; <code>SW↓</code> and <code>LW↓</code> are the downward fluxes in short and long wavelength bands. We use the same roughness lengths for snow and soil. Note that with the exception of precipitation and downwelling radiation, all fluxes are defined such that positive is towards the atmosphere.</p><p>As the temperature at the surface of the soil and snow is the same, only the evaporation changes between the two surface coverage types. We have</p><p><span>$E_{soil} =  β(W, W_f) E(q_{sat}(T_{sfc}, ρ_{sfc}; liquid),$</span></p><p>where β is the factor used in [1] which accounts for the fact that soil does not evaporate at the potential rate when it is not saturated. This makes use of the field capacity parameter <code>W_f</code>. We also have</p><p><span>$E_{snow} = E(q_{sat}(T_{sfc}, ρ_{sfc}; ice).$</span></p><h1 id="Simulating-a-standalone-bucket-model"><a class="docs-heading-anchor" href="#Simulating-a-standalone-bucket-model">Simulating a standalone bucket model</a><a id="Simulating-a-standalone-bucket-model-1"></a><a class="docs-heading-anchor-permalink" href="#Simulating-a-standalone-bucket-model" title="Permalink"></a></h1><p>First, we need to import necessary packages. We use <a href="https://github.com/SciML/SciMLBase.jl">SciMLBase.jl</a> and <a href="https://github.com/CliMA/ClimaTimeSteppers.jl">ClimaTimeSteppers.jl</a> for the timestepping.</p><pre><code class="language-julia hljs">import SciMLBase
import ClimaTimeSteppers as CTS</code></pre><p>We use <a href="https://github.com/CliMA/ClimaCore.jl">ClimaCore</a> for setting up the domain/coordinate points. While this infrastructure isn&#39;t really necessary for standalone simulations, adhering to it makes setting up coupled simulations very easy. It also is nice to rely on ClimaCore utilities because they have been designed in advance for running distributed simulations.</p><pre><code class="language-julia hljs">using ClimaCore</code></pre><p>We also use CLIMAParameters, which strives to ensure a common set of parameters across all Clima models, and to make parameter estimation more seamless.</p><pre><code class="language-julia hljs">import CLIMAParameters as CP</code></pre><p>We also use Insolation to calculate solar zenith angle and solar insolation.</p><pre><code class="language-julia hljs">using Insolation</code></pre><p>Lastly, let&#39;s bring in the bucket model types (from ClimaLSM) that we will need access to.</p><pre><code class="language-julia hljs">using ClimaLSM.Bucket: BucketModel, BucketModelParameters, BulkAlbedoFunction
using ClimaLSM.Domains: coordinates, Column
using ClimaLSM:
    initialize,
    make_update_aux,
    make_exp_tendency,
    make_set_initial_aux_state,
    PrescribedAtmosphere,
    PrescribedRadiativeFluxes</code></pre><p>We also want to plot the solution</p><pre><code class="language-julia hljs">using Plots</code></pre><p>And we need to use the DateTime type to store reference times</p><pre><code class="language-julia hljs">using Dates

FT = Float64;</code></pre><p>As mentioned we use CLIMAParameters for earth parameters that are required across models (e.g. the density of water and ice, the latent heat of fusion at a reference temperature, etc). The land model requires additional parameters as described in the text above. These two sets are combined in the object <code>BucketModelParameters</code> as follows:</p><pre><code class="language-julia hljs">import ClimaLSM
include(joinpath(pkgdir(ClimaLSM), &quot;parameters&quot;, &quot;create_parameters.jl&quot;));
earth_param_set = create_lsm_parameters(FT);</code></pre><p>Define our <code>BulkAlbedoFunction</code> model using a constant surface and snow albedo: The surface albedo is a function of coordinates, which would be (x,y) on a plane, and (lat,lon) on a sphere. Another albedo option is to specify a <code>BulkAlbedoStatic</code> or <code>BulkAlbedoFunction</code>, which uses a NetCDF file to read in surface albedo. These options only applies when coordinates are (lat,lon).</p><pre><code class="language-julia hljs">α_sfc = (coordinate_point) -&gt; FT(0.2);
α_snow = FT(0.8);
albedo = BulkAlbedoFunction{FT}(α_snow, α_sfc);</code></pre><p>The critical snow level setting the scale for when we interpolate between snow and surface albedo</p><pre><code class="language-julia hljs">σS_c = FT(0.2);</code></pre><p>The field capacity of the soil</p><pre><code class="language-julia hljs">W_f = FT(0.15);</code></pre><p>Roughness lengths (meters)</p><pre><code class="language-julia hljs">z_0m = FT(1e-2);
z_0b = FT(1e-3);</code></pre><p>Thermal parameters of soil</p><pre><code class="language-julia hljs">κ_soil = FT(0.7);
ρc_soil = FT(2e6);</code></pre><p>Simulation start time, end time, and timestep</p><pre><code class="language-julia hljs">t0 = FT(0.0);
tf = FT(7 * 86400);
Δt = FT(3600.0);

bucket_parameters = BucketModelParameters(
    κ_soil,
    ρc_soil,
    albedo,
    σS_c,
    W_f,
    z_0m,
    z_0b,
    Δt,
    earth_param_set,
);</code></pre><p>Set up the model domain. At every surface coordinate point, we&#39;ll solve an ODE for <code>W</code> and <code>Ws</code>, and for every subsurface point, we solve for <code>T</code>. In coupled simulations run at the same resolution as the atmosphere, the bucket horizontal resolution would match the horizontal resolution at the lowest level of the atmosphere model. In general, however, the two resolutions do not need to match. Here we just set up something simple - a Column.</p><pre><code class="language-julia hljs">soil_depth = FT(3.5);
bucket_domain = Column(; zlim = (-soil_depth, 0.0), nelements = 10);</code></pre><p>The PrescribedAtmosphere and PrescribedRadiation need to take in a reference time, the date of the start of the simulation. In this tutorial we will consider this January 1, 2005.</p><pre><code class="language-julia hljs">ref_time = DateTime(2005);</code></pre><p>To drive the system in standalone mode, the user must provide prescribed functions of time for the water volume flux in precipitation,  for the net downward shortwave and longwave radiative energy fluxes (<code>SW↓, LW↓</code>, W/m^2), for the atmospheric temperature <code>T_a</code>, wind speed <code>u_a</code> (m/s), specific humidity <code>q_a</code>, and air density <code>ρ_a</code> (kg/m^3) at a reference height <code>h_a</code> (m).</p><p>Here we define the model drivers, starting with downward radiation.</p><pre><code class="language-julia hljs">SW_d = (t) -&gt; eltype(t)(300);
LW_d = (t) -&gt; eltype(t)(300);
bucket_rad = PrescribedRadiativeFluxes(
    FT,
    SW_d,
    LW_d,
    ref_time;
    orbital_data = Insolation.OrbitalData(),
);</code></pre><p>Prescribed atmospheric variables</p><p>Stochastic precipitation:</p><pre><code class="language-julia hljs">precip = (t) -&gt; eltype(t)(0);
snow_precip = (t) -&gt; eltype(t)(5e-7 * (t &gt; 3 * 86400) * (t &lt; 4 * 86400));</code></pre><p>Diurnal temperature variations:</p><pre><code class="language-julia hljs">T_atmos = (t) -&gt; eltype(t)(275.0 + 5.0 * sin(2.0 * π * t / 86400 + 7200));</code></pre><p>Constant otherwise:</p><pre><code class="language-julia hljs">u_atmos = (t) -&gt; eltype(t)(3.0);
q_atmos = (t) -&gt; eltype(t)(0.005);
h_atmos = FT(2);
P_atmos = (t) -&gt; eltype(t)(101325);
bucket_atmos = PrescribedAtmosphere(
    precip,
    snow_precip,
    T_atmos,
    u_atmos,
    q_atmos,
    P_atmos,
    ref_time,
    h_atmos,
);</code></pre><p>Then, we create the model object, which contains the drivers, parameters, domain, and is associated with the correct differential equations for the bucket model:</p><pre><code class="language-julia hljs">model = BucketModel(
    parameters = bucket_parameters,
    domain = bucket_domain,
    atmosphere = bucket_atmos,
    radiation = bucket_rad,
);</code></pre><p>Note the holder structs for the radiation and atmosphere functions: they are named <code>Prescribed</code>. In coupled simulations, we would use a different type and rely on multiple dispatch to obtain the atmospheric and radiative quantitites from the coupler.</p><p>Like all ClimaLSM models, we set up the state vector using <code>initialize</code>:</p><pre><code class="language-julia hljs">Y, p, coords = initialize(model);</code></pre><p>We can inspect the prognostic and auxiliary variables of the model:</p><pre><code class="language-julia hljs">ClimaLSM.prognostic_vars(model)
Y.bucket |&gt; propertynames</code></pre><pre><code class="nohighlight hljs">(:W, :T, :Ws, :σS)</code></pre><p>The auxiliary variables in this case are the surface temperature, the turbulent fluxes, the net radiation, and the surface specific humidity.</p><pre><code class="language-julia hljs">ClimaLSM.auxiliary_vars(model)
p.bucket |&gt; propertynames</code></pre><pre><code class="nohighlight hljs">(:q_sfc, :evaporation, :turbulent_energy_flux, :R_n, :T_sfc, :α_sfc, :ρ_sfc)</code></pre><p>Next is to set initial conditions.</p><pre><code class="language-julia hljs">Y.bucket.T .= FT(270);
Y.bucket.W .= FT(0.05);
Y.bucket.Ws .= FT(0.0);
Y.bucket.σS .= FT(0.08);</code></pre><p>We also set the initial conditions of the auxiliary state here:</p><pre><code class="language-julia hljs">set_initial_aux_state! = make_set_initial_aux_state(model);
set_initial_aux_state!(p, Y, t0);</code></pre><p>Then to create the entire right hand side (tendency) function for the system of ordinary differential equations:</p><pre><code class="language-julia hljs">exp_tendency! = make_exp_tendency(model);</code></pre><p>Now we choose our timestepping algorithm.</p><pre><code class="language-julia hljs">timestepper = CTS.RK4()
ode_algo = CTS.ExplicitAlgorithm(timestepper)</code></pre><pre><code class="nohighlight hljs">ClimaTimeSteppers.IMEXAlgorithm{ClimaTimeSteppers.Unconstrained, ClimaTimeSteppers.RK4, ClimaTimeSteppers.IMEXTableau{StaticArraysCore.SVector{4, Float64}, StaticArraysCore.SMatrix{4, 4, Float64, 16}}, Nothing}(ClimaTimeSteppers.Unconstrained(), ClimaTimeSteppers.RK4(), ClimaTimeSteppers.IMEXTableau{StaticArraysCore.SVector{4, Float64}, StaticArraysCore.SMatrix{4, 4, Float64, 16}}([0.0 0.0 0.0 0.0; 0.5 0.0 0.0 0.0; 0.0 0.5 0.0 0.0; 0.0 0.0 1.0 0.0], [0.16666666666666666, 0.3333333333333333, 0.3333333333333333, 0.16666666666666666], [0.0, 0.5, 0.5, 1.0], [0.0 0.0 0.0 0.0; 0.5 0.0 0.0 0.0; 0.0 0.5 0.0 0.0; 0.0 0.0 1.0 0.0], [0.16666666666666666, 0.3333333333333333, 0.3333333333333333, 0.16666666666666666], [0.0, 0.5, 0.5, 1.0]), nothing)</code></pre><p>Then we can set up the simulation and solve it:</p><pre><code class="language-julia hljs">prob = SciMLBase.ODEProblem(
    CTS.ClimaODEFunction(T_exp! = exp_tendency!, dss! = ClimaLSM.dss!),
    Y,
    (t0, tf),
    p,
);</code></pre><p>We need a callback to get and store the auxiliary fields, as they are not stored by default.</p><pre><code class="language-julia hljs">saveat = collect(t0:Δt:tf);
saved_values = (;
    t = Array{FT}(undef, length(saveat)),
    saveval = Array{NamedTuple}(undef, length(saveat)),
);

cb = ClimaLSM.NonInterpSavingCallback(saved_values, saveat);

sol = SciMLBase.solve(prob, ode_algo; dt = Δt, saveat = saveat, callback = cb);</code></pre><p>Extracting the solution from what is returned by the ODE.jl commands is a bit clunky right now, but we are working on hiding some of this. <code>parent</code> extracts the underlying data from the ClimaCore.Fields.Field object and we loop over the solution <code>sol</code> because of how the data is stored within solutions returned by ODE.jl - indexed by timestep.</p><pre><code class="language-julia hljs">W = [parent(sol.u[k].bucket.W)[1] for k in 1:length(sol.t)];
Ws = [parent(sol.u[k].bucket.Ws)[1] for k in 1:length(sol.t)];
σS = [parent(sol.u[k].bucket.σS)[1] for k in 1:length(sol.t)];
T_sfc =
    [parent(saved_values.saveval[k].bucket.T_sfc)[1] for k in 1:length(sol.t)];
evaporation = [
    parent(saved_values.saveval[k].bucket.evaporation)[1] for
    k in 1:length(sol.t)
];
R_n = [parent(saved_values.saveval[k].bucket.R_n)[1] for k in 1:length(sol.t)];</code></pre><p>The turbulent energy flux is the sum of latent and sensible heat fluxes.</p><pre><code class="language-julia hljs">turbulent_energy_flux = [
    parent(saved_values.saveval[k].bucket.turbulent_energy_flux)[1] for
    k in 1:length(sol.t)
];


plot(
    sol.t ./ 86400,
    W,
    label = &quot;&quot;,
    xlabel = &quot;time (days)&quot;,
    ylabel = &quot;W (m)&quot;,
    title = &quot;Land water storage (m)&quot;,
)
savefig(&quot;w.png&quot;)</code></pre><pre><code class="nohighlight hljs">&quot;/home/runner/work/ClimaLSM.jl/ClimaLSM.jl/docs/src/generated/Bucket/w.png&quot;</code></pre><p><img src="../w.png" alt/></p><pre><code class="language-julia hljs">plot(
    sol.t ./ 86400,
    σS,
    label = &quot;&quot;,
    xlabel = &quot;time (days)&quot;,
    ylabel = &quot;σS (m)&quot;,
    title = &quot;Area weighted SWE (m) &quot;,
)
savefig(&quot;swe.png&quot;)</code></pre><pre><code class="nohighlight hljs">&quot;/home/runner/work/ClimaLSM.jl/ClimaLSM.jl/docs/src/generated/Bucket/swe.png&quot;</code></pre><p><img src="../swe.png" alt/></p><pre><code class="language-julia hljs">plot(
    sol.t ./ 86400,
    -snow_precip.(sol.t),
    label = &quot;Net precipitation&quot;,
    xlabel = &quot;time (days)&quot;,
    ylabel = &quot;Flux (m/s)&quot;,
    title = &quot;Surface water fluxes&quot;,
    legend = :bottomright,
)
plot!(sol.t ./ 86400, evaporation, label = &quot;Sublimation/Evaporation&quot;)
savefig(&quot;water_f.png&quot;)</code></pre><pre><code class="nohighlight hljs">&quot;/home/runner/work/ClimaLSM.jl/ClimaLSM.jl/docs/src/generated/Bucket/water_f.png&quot;</code></pre><p><img src="../water_f.png" alt/></p><pre><code class="language-julia hljs">plot(
    sol.t ./ 86400,
    T_sfc,
    title = &quot;Surface Temperatures&quot;,
    label = &quot;Ground temperature&quot;,
    xlabel = &quot;time (days)&quot;,
    ylabel = &quot;T_sfc (K)&quot;,
    legend = :bottomright,
)
plot!(sol.t ./ 86400, T_atmos.(sol.t), label = &quot;Atmospheric Temperature&quot;)
savefig(&quot;t.png&quot;)</code></pre><pre><code class="nohighlight hljs">&quot;/home/runner/work/ClimaLSM.jl/ClimaLSM.jl/docs/src/generated/Bucket/t.png&quot;</code></pre><p><img src="../t.png" alt/></p><pre><code class="language-julia hljs">plot(
    sol.t ./ 86400,
    R_n,
    label = &quot;Net radiative flux&quot;,
    xlabel = &quot;time (days)&quot;,
    ylabel = &quot;Flux (W/m^2)&quot;,
    title = &quot;Surface energy fluxes&quot;,
    legend = :bottomright,
)
plot!(sol.t ./ 86400, turbulent_energy_flux, label = &quot;Turbulent fluxes&quot;)
plot!(sol.t ./ 86400, R_n .+ turbulent_energy_flux, label = &quot;Net flux&quot;)
savefig(&quot;energy_f.png&quot;)</code></pre><pre><code class="nohighlight hljs">&quot;/home/runner/work/ClimaLSM.jl/ClimaLSM.jl/docs/src/generated/Bucket/energy_f.png&quot;</code></pre><p><img src="../energy_f.png" alt/></p><h1 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h1><p>[1] Manabe, S. (1969) CLIMATE AND THE OCEAN CIRCULATION I: The Atmospheric Circulation and the Hydrology of the Earth&#39;s Surface. Monthly Weather Review, Volume 97: Issue 11, p 739-774. [2] Milly, P. C. D. and Shmakin, A.B. (2002) Global Modeling of Land Water and Energy Balances. Part I: The Land Dynamics (LaD) Model Journal of Hydrometeorology, Volume 3: Issue 3, p 283-299. [3] Laguë, M., Bonan, G., and Swann, A. (2019) Seperating the Impact of Individual Land Surface Properties on the Terrestrial Surface Energy Budget in both the Coupled and Uncoupled Land-Atmosphere System Volume 32: Issue 18, p 5725-5744</p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../Canopy/soil_canopy_tutorial/">« Coupled Canopy and Soil</a><a class="docs-footer-nextpage" href="../coupled_bucket/">Setting up a Coupled Simulation »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.1.2 on <span class="colophon-date" title="Thursday 9 November 2023 19:26">Thursday 9 November 2023</span>. Using Julia version 1.9.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
